name: CI Pipeline

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test:
    name: Test & Build Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: |
        echo "ðŸ§ª Running Jest tests..."
        npm run test:ci

    - name: Generate coverage report
      run: |
        echo "ðŸ“Š Generating coverage report..."
        npm run test:coverage
      continue-on-error: true

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        files: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-medilex
      continue-on-error: true

    - name: Archive coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  expo-validation:
    name: Expo Configuration Validation
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate Expo configuration
      run: |
        echo "âš™ï¸ Validating Expo configuration..."

        # Check for app.json
        if [ -f "app.json" ]; then
          echo "âœ… app.json found"

          # Validate app.json structure
          if command -v jq > /dev/null; then
            APP_NAME=$(jq -r '.expo.name' app.json)
            APP_SLUG=$(jq -r '.expo.slug' app.json)
            SDK_VERSION=$(jq -r '.expo.sdkVersion' app.json)

            echo "ðŸ“± Expo App Configuration:"
            echo "  Name: $APP_NAME"
            echo "  Slug: $APP_SLUG"
            echo "  SDK Version: $SDK_VERSION"

            if [ "$APP_NAME" != "null" ] && [ "$APP_SLUG" != "null" ]; then
              echo "âœ… Required Expo fields present"
            else
              echo "âŒ Missing required Expo fields"
              exit 1
            fi
          fi
        else
          echo "âŒ app.json not found"
          exit 1
        fi

        # Check for eas.json
        if [ -f "eas.json" ]; then
          echo "âœ… eas.json found (EAS Build configured)"
        else
          echo "âš ï¸ eas.json not found - EAS Build not configured"
        fi

    - name: Validate Expo dependencies
      run: |
        echo "ðŸ“¦ Validating Expo dependencies..."

        # Check for expo package
        if npm list expo > /dev/null 2>&1; then
          EXPO_VERSION=$(npm list expo --depth=0 | grep expo@ | sed 's/.*expo@//' | sed 's/ .*//')
          echo "âœ… Expo SDK installed: $EXPO_VERSION"
        else
          echo "âŒ Expo SDK not found in dependencies"
          exit 1
        fi

        # Check for React Native
        if npm list react-native > /dev/null 2>&1; then
          RN_VERSION=$(npm list react-native --depth=0 | grep react-native@ | sed 's/.*react-native@//' | sed 's/ .*//')
          echo "âœ… React Native installed: $RN_VERSION"
        else
          echo "âŒ React Native not found in dependencies"
          exit 1
        fi

    - name: Expo prebuild validation
      run: |
        echo "ðŸ”¨ Validating Expo prebuild..."

        # Test that expo prebuild would work (dry-run)
        npx expo prebuild --no-install --platform all --clean || echo "âš ï¸ Expo prebuild validation had issues"

  react-native-validation:
    name: React Native Validation
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: React Native component validation
      run: |
        echo "ðŸ§© Validating React Native components..."

        # Check for React Native specific patterns
        if grep -r "import.*from 'react-native'" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "âœ… React Native components found"
        else
          echo "âš ï¸ No React Native imports detected"
        fi

        # Check for navigation
        if npm list @react-navigation/native > /dev/null 2>&1; then
          echo "âœ… React Navigation installed"
        else
          echo "âš ï¸ React Navigation not found"
        fi

    - name: Mobile-specific checks
      run: |
        echo "ðŸ“± Running mobile-specific checks..."

        # Check for AsyncStorage usage
        if grep -r "AsyncStorage" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "âœ… AsyncStorage usage detected"

          # Check for proper AsyncStorage imports
          if grep -r "@react-native-async-storage/async-storage" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "âœ… Using recommended AsyncStorage package"
          else
            echo "âš ï¸ Using deprecated AsyncStorage - consider upgrading"
          fi
        fi

        # Check for medical vocabulary data files
        if [ -d "src/data" ] || [ -d "assets/data" ]; then
          echo "âœ… Data directory found (likely contains medical vocabulary)"
        fi

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [test, expo-validation, react-native-validation]
    if: always()

    steps:
    - name: Check job results
      run: |
        echo "ðŸ“Š CI Pipeline Summary"
        echo "======================"
        echo ""
        echo "Test: ${{ needs.test.result }}"
        echo "Expo Validation: ${{ needs.expo-validation.result }}"
        echo "React Native Validation: ${{ needs.react-native-validation.result }}"
        echo ""

        if [ "${{ needs.test.result }}" != "success" ]; then
          echo "âŒ Tests failed"
          exit 1
        fi

        if [ "${{ needs.expo-validation.result }}" != "success" ]; then
          echo "âŒ Expo validation failed"
          exit 1
        fi

        if [ "${{ needs.react-native-validation.result }}" != "success" ]; then
          echo "âŒ React Native validation failed"
          exit 1
        fi

        echo "âœ… All quality gates passed!"

    - name: Summary
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Expo Validation | ${{ needs.expo-validation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| React Native Validation | ${{ needs.react-native-validation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**All quality gates passed! ðŸŽ‰**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Build Android/iOS via EAS Build workflows" >> $GITHUB_STEP_SUMMARY
        echo "- Test on physical devices" >> $GITHUB_STEP_SUMMARY
        echo "- Validate medical vocabulary functionality" >> $GITHUB_STEP_SUMMARY
