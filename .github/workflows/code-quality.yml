name: Code Quality & Standards

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly quality checks on main branch
    - cron: '0 2 * * 1'  # Monday 2 AM UTC
  workflow_dispatch:

jobs:
  react-native-lint:
    name: React Native Linting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: |
        echo "üîç Running ESLint for React Native..."
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
          npm run lint || echo "‚ö†Ô∏è Linting found issues"
        else
          echo "‚ö†Ô∏è ESLint configuration not found"
        fi

    - name: Check for React Native anti-patterns
      run: |
        echo "üì± Checking for React Native anti-patterns..."

        # Check for console.log statements
        if grep -r "console\.log\|console\.warn" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" | grep -v "test\|spec"; then
          echo "‚ö†Ô∏è Console statements found - remove before production"
        else
          echo "‚úÖ No console statements in source code"
        fi

        # Check for inline styles (performance concern)
        INLINE_STYLES=$(grep -r "style={{" src/ --include="*.js" --include="*.jsx" --include="*.tsx" | wc -l)
        if [ "$INLINE_STYLES" -gt 10 ]; then
          echo "‚ö†Ô∏è Many inline styles found ($INLINE_STYLES) - consider using StyleSheet.create"
        else
          echo "‚úÖ Inline styles usage is reasonable"
        fi

  mobile-code-standards:
    name: Mobile Code Standards
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check data handling patterns
      run: |
        echo "üìä Checking data handling patterns..."

        # Check for AsyncStorage usage
        if grep -r "AsyncStorage" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"; then
          echo "‚úÖ AsyncStorage usage found"

          # Check for proper error handling with AsyncStorage
          if grep -r "AsyncStorage.*try\|AsyncStorage.*catch" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "‚úÖ Error handling found with AsyncStorage"
          else
            echo "‚ö†Ô∏è AsyncStorage may lack error handling"
          fi
        fi

    - name: Check navigation patterns
      run: |
        echo "üß≠ Checking navigation patterns..."

        if npm list @react-navigation/native > /dev/null 2>&1; then
          echo "‚úÖ React Navigation installed"

          # Check for proper navigation typing
          if grep -r "NavigationProp\|RouteProp" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "‚úÖ Navigation typing detected"
          else
            echo "‚ö†Ô∏è Consider adding navigation typing for type safety"
          fi
        fi

    - name: Medical vocabulary validation
      run: |
        echo "üè• Validating medical vocabulary implementation..."

        # Check for medical data files
        if [ -d "src/data" ] || [ -d "assets/data" ]; then
          echo "‚úÖ Data directory found"

          # Check for medical terminology files
          if find src/ assets/ -name "*vocab*" -o -name "*medical*" -o -name "*terms*" 2>/dev/null | grep -q .; then
            echo "‚úÖ Medical terminology files detected"
          else
            echo "‚ö†Ô∏è Medical terminology files not clearly identified"
          fi
        fi

  performance-check:
    name: Performance Patterns Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for performance patterns
      run: |
        echo "‚ö° Checking for performance anti-patterns..."

        # Check for FlatList usage (recommended for lists)
        if grep -r "FlatList\|SectionList" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "‚úÖ Using optimized list components"
        else
          echo "‚ö†Ô∏è Consider using FlatList for long lists"
        fi

        # Check for useMemo/useCallback usage
        if grep -r "useMemo\|useCallback" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "‚úÖ Performance optimization hooks detected"
        else
          echo "‚ö†Ô∏è Consider using useMemo/useCallback for optimization"
        fi

        # Check for large images
        if [ -d "assets/images" ]; then
          LARGE_IMAGES=$(find assets/images -name "*.png" -o -name "*.jpg" -exec du -k {} \; 2>/dev/null | awk '$1 > 500 {print $0}' | wc -l)
          if [ "$LARGE_IMAGES" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $LARGE_IMAGES images > 500KB - consider optimization"
          else
            echo "‚úÖ Image sizes are reasonable"
          fi
        fi

  accessibility-check:
    name: Mobile Accessibility Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check accessibility patterns
      run: |
        echo "‚ôø Checking mobile accessibility patterns..."

        # Check for accessibilityLabel usage
        if grep -r "accessibilityLabel" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "‚úÖ Accessibility labels found"
        else
          echo "‚ö†Ô∏è Consider adding accessibility labels"
        fi

        # Check for accessibilityRole
        if grep -r "accessibilityRole" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" > /dev/null; then
          echo "‚úÖ Accessibility roles defined"
        else
          echo "‚ö†Ô∏è Consider adding accessibility roles"
        fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [react-native-lint, mobile-code-standards, performance-check, accessibility-check]
    if: always()

    steps:
    - name: Quality gate summary
      run: |
        echo "üìä Code Quality Summary"
        echo "======================"
        echo ""

        if [ "${{ needs.react-native-lint.result }}" = "success" ]; then
          echo "‚úÖ React Native Linting: PASSED"
        else
          echo "‚ùå React Native Linting: FAILED"
        fi

        if [ "${{ needs.mobile-code-standards.result }}" = "success" ]; then
          echo "‚úÖ Mobile Code Standards: PASSED"
        else
          echo "‚ùå Mobile Code Standards: FAILED"
        fi

        if [ "${{ needs.performance-check.result }}" = "success" ]; then
          echo "‚úÖ Performance Check: PASSED"
        else
          echo "‚ùå Performance Check: FAILED"
        fi

        if [ "${{ needs.accessibility-check.result }}" = "success" ]; then
          echo "‚úÖ Accessibility Check: PASSED"
        else
          echo "‚ùå Accessibility Check: FAILED"
        fi

        echo ""
        echo "üéØ Overall Quality Gate: $(if [ "${{ needs.react-native-lint.result }}" = "success" ] && [ "${{ needs.mobile-code-standards.result }}" = "success" ]; then echo "PASSED ‚úÖ"; else echo "REVIEW REQUIRED ‚ö†Ô∏è"; fi)"
